apiVersion: batch/v1
kind: CronJob
metadata:
  name: mailgun-keepalive
spec:
  schedule: "0 9 * * mon" # 09:00 on Mondays
  timeZone: "America/Chicago"
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      # 2 retries is up to 3 total attempts
      backoffLimit: 2
      template:
        spec:
          containers:
            - name: mailgun-keepalive
              image: curl
              env:
                - name: MAILGUN_DOMAIN_NAME
                  value: mail.fivebytestudios.com
                - name: MAILGUN_SENDING_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: mailgun-keepalive-sending-api-key
                      key: sending_api_key
                - name: RECIPIENT_EMAIL_ADDRESS
                  valueFrom:
                    secretKeyRef:
                      name: mailgun-keepalive-recipient-address
                      key: recipient_email_address
              args:
                - /bin/sh
                - -c
                - >
                  curl
                  --fail
                  --no-progress-meter
                  --user "api:${MAILGUN_SENDING_API_KEY}"
                  https://api.mailgun.net/v3/$MAILGUN_DOMAIN_NAME/messages
                  -F from="Mailgun Keepalive <postmaster@${MAILGUN_DOMAIN_NAME}>"
                  -F to="${RECIPIENT_EMAIL_ADDRESS}"
                  -F subject="Mailgun Keepalive"
                  -F text="Keeping mailgun alive, one week at a time."
          restartPolicy: Never
