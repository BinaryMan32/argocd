# https://github.com/prometheus-community/helm-charts/blob/main/charts/kube-prometheus-stack/values.yaml
kube-prometheus-stack:

  # k3s has all of these components in a single process
  # metrics already collected by kubelet
  # see https://github.com/k3s-io/k3s/issues/3619#issuecomment-1425852034
  kubeControllerManager:
    enabled: false
  kubeProxy:
    enabled: false
  kubeScheduler:
    enabled: false
  kubelet:
    serviceMonitor:
      metricRelabelings:
        # k3s exposes all metrics on all endpoints, relabel jobs that belong to other components
        - action: replace
          sourceLabels: [__name__]
          regex: "scheduler_(.+)"
          targetLabel: "job"
          replacement: "kube-scheduler"
        - action: replace
          sourceLabels: [__name__]
          regex: "kubeproxy_(.+)"
          targetLabel: "job"
          replacement: "kube-proxy"
  coreDns:
    service:
      selector:
        k8s-app: coredns
  kubeEtcd:
    enabled: false

  global:
    rbac:
      createAggregateClusterRoles: true

  alertmanager:
    config:
      global:
        slack_api_url_file: /etc/alertmanager/secrets/slack-api/url

      receivers:
        - name: "null"
        - name: fbs-discord
          # TODO remove slack when we're comfortable with discord only
          slack_configs:
            - channel: #devops
              send_resolved: true
              # Message template from https://grafana.com/blog/2020/02/25/step-by-step-guide-to-setting-up-prometheus-alertmanager-with-slack-pagerduty-and-gmail/
              icon_url: https://avatars3.githubusercontent.com/u/3380462
              title: |-
                [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }} for {{ .CommonLabels.job }}
                {{- if gt (len .CommonLabels) (len .GroupLabels) -}}
                  {{" "}}(
                  {{- with .CommonLabels.Remove .GroupLabels.Names }}
                    {{- range $index, $label := .SortedPairs -}}
                      {{ if $index }}, {{ end }}
                      {{- $label.Name }}="{{ $label.Value -}}"
                    {{- end }}
                  {{- end -}}
                  )
                {{- end }}
              text: >-
                {{ range .Alerts -}}
                *Alert:* {{ .Annotations.summary }}{{ if .Labels.severity }} - `{{ .Labels.severity }}`{{ end }}

                *Description:* {{ .Annotations.description }} {{ if .Annotations.runbook_url }}(<{{ .Annotations.runbook_url }}|Runbook>){{ end }}

                *Details:*
                  {{ range .Labels.SortedPairs }} â€¢ *{{ .Name }}:* `{{ .Value }}`
                  {{ end }}
                {{ end }}
          discord_configs:
            # https://prometheus.io/docs/alerting/latest/configuration/#discord_config
            - send_resolved: true
              # We'd like to be able to do this
              # webhook_url_file: /etc/alertmanager/secrets/discord-webhook-fbs/webhook_url
              # However, it shows the following error in the prometheus operator logs:
              # provision alertmanager configuration: failed to initialize from secret: yaml: unmarshal errors:
              #   line 57: field webhook_url_file not found in type alertmanager.discordConfig"
              # These PRs would add the functionality, but have been open for years:
              # - https://github.com/prometheus-operator/prometheus-operator/pull/6346
              # - https://github.com/prometheus-operator/prometheus-operator/pull/8035
              # As a workaround, create an nginx deployment which proxies requests to the webhook url in the secret:
              # https://github.com/Tyraeis/minilab/commit/0a29eb1d14e418b54809af58c0bc9d5c4e8a53f1
              # https://github.com/Tyraeis/minilab/commit/353d9adb7d4d6c0339f8e1880d66f03c54fe3184
              webhook_url: http://discord-webhook-proxy-fbs.kube-prometheus-stack.svc.cluster.local
              username: Alertmanager
              avatar_url: https://avatars3.githubusercontent.com/u/3380462
              title: |-
                {{ if eq .Status "resolved" }}:white_check_mark:{{ else }}:warning:{{ end }} [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }} for {{ .CommonLabels.job }}
                {{- if gt (len .CommonLabels) (len .GroupLabels) -}}
                  {{" "}}(
                  {{- with .CommonLabels.Remove .GroupLabels.Names }}
                    {{- range $index, $label := .SortedPairs -}}
                      {{ if $index }}, {{ end }}
                      {{- $label.Name }}="{{ $label.Value -}}"
                    {{- end }}
                  {{- end -}}
                  )
                {{- end }}
              message: |
                {{ range .Alerts -}}
                **Alert:** {{ .Annotations.summary }}{{ if .Labels.severity }} - `{{ .Labels.severity }}`{{ end }}
                **Description:** {{ .Annotations.description }} {{ if .Annotations.runbook_url }}([Runbook]({{ .Annotations.runbook_url }})){{ end }}
                **Details:**
                {{ range .Labels.SortedPairs -}}
                - **{{ .Name }}:** `{{ .Value }}`
                {{ end }}
                {{ end }}
        - name: play-when-discord
          discord_configs:
            # https://prometheus.io/docs/alerting/latest/configuration/#discord_config
            - send_resolved: true
              # We'd like to be able to do this
              # webhook_url_file: /etc/alertmanager/secrets/discord-webhook-play-when/webhook_url
              # However, it shows the following error in the prometheus operator logs:
              # provision alertmanager configuration: failed to initialize from secret: yaml: unmarshal errors:
              #   line 57: field webhook_url_file not found in type alertmanager.discordConfig"
              # These PRs would add the functionality, but have been open for years:
              # - https://github.com/prometheus-operator/prometheus-operator/pull/6346
              # - https://github.com/prometheus-operator/prometheus-operator/pull/8035
              # As a workaround, create an nginx deployment which proxies requests to the webhook url in the secret:
              # https://github.com/Tyraeis/minilab/commit/0a29eb1d14e418b54809af58c0bc9d5c4e8a53f1
              # https://github.com/Tyraeis/minilab/commit/353d9adb7d4d6c0339f8e1880d66f03c54fe3184
              webhook_url: http://discord-webhook-proxy-play-when.kube-prometheus-stack.svc.cluster.local
              username: Alertmanager
              avatar_url: https://avatars3.githubusercontent.com/u/3380462
              title: |-
                {{ if eq .Status "resolved" }}:white_check_mark:{{ else }}:warning:{{ end }} [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }} for {{ .CommonLabels.job }}
                {{- if gt (len .CommonLabels) (len .GroupLabels) -}}
                  {{" "}}(
                  {{- with .CommonLabels.Remove .GroupLabels.Names }}
                    {{- range $index, $label := .SortedPairs -}}
                      {{ if $index }}, {{ end }}
                      {{- $label.Name }}="{{ $label.Value -}}"
                    {{- end }}
                  {{- end -}}
                  )
                {{- end }}
              message: |
                {{ range .Alerts -}}
                **Alert:** {{ .Annotations.summary }}{{ if .Labels.severity }} - `{{ .Labels.severity }}`{{ end }}
                **Description:** {{ .Annotations.description }} {{ if .Annotations.runbook_url }}([Runbook]({{ .Annotations.runbook_url }})){{ end }}
                **Details:**
                {{ range .Labels.SortedPairs -}}
                - **{{ .Name }}:** `{{ .Value }}`
                {{ end }}
                {{ end }}

      # https://prometheus.io/docs/alerting/latest/configuration/#route
      route:
        group_by: ['namespace']
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 2h
        receiver: fbs-discord
        routes:
          # Some alert types should be sent to null
          # https://runbooks.prometheus-operator.dev/runbooks/general/infoinhibitor/
          # https://runbooks.prometheus-operator.dev/runbooks/general/watchdog/
          - receiver: 'null'
            matchers:
              - alertname =~ "InfoInhibitor|Watchdog"
          - receiver: play-when-discord
            matchers:
              - namespace =~ play-when.*
            # Also handled by root route
            continue: true

    alertmanagerSpec:
      storage:
        volumeClaimTemplate:
          spec:
            storageClassName: longhorn
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 2Gi
      secrets:
        - slack-api

  # https://github.com/grafana/helm-charts/blob/main/charts/grafana/values.yaml
  grafana:
    admin:
      existingSecret: "grafana-login"
    persistence:
      enabled: true
      type: statefulset
      storageClassName: longhorn
      size: 2Gi

  prometheus:
    prometheusSpec:
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: longhorn
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 50Gi
      # By default, the prometheus operator selects resources to watch using the `release` label.
      # Setting `*SelectorNilUsesHelmValues: false` disables this to watch all resources.
      ruleSelectorNilUsesHelmValues: false
      serviceMonitorSelectorNilUsesHelmValues: false
      podMonitorSelectorNilUsesHelmValues: false
      probeSelectorNilUsesHelmValues: false
      scrapeConfigSelectorNilUsesHelmValues: false
